<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Migs Germar">
<meta name="dcterms.date" content="2021-07-31">
<meta name="description" content="I use intermediate SQL techniques like views, joins, aggregations, and set operations in order to solve 4 scenarios about a hypothetical online music store. Results are communicated with Matplotlib and Altair visualizations.">

<title>Migs Germar’s Data Science Blog - Answering Business Questions for an Online Music Store using SQL</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../posts/images/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-99SLFW8P3J"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-99SLFW8P3J', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Migs Germar’s Data Science Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/MiguelAHG" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/migs-germar/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.facebook.com/miguelantonio.germar" rel="" target=""><i class="bi bi-facebook" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Answering Business Questions for an Online Music Store using SQL</h1>
                  <div>
        <div class="description">
          I use intermediate SQL techniques like views, joins, aggregations, and set operations in order to solve 4 scenarios about a hypothetical online music store. Results are communicated with Matplotlib and Altair visualizations.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">sql</div>
                <div class="quarto-category">sqlite</div>
                <div class="quarto-category">python</div>
                <div class="quarto-category">pandas</div>
                <div class="quarto-category">matplotlib</div>
                <div class="quarto-category">seaborn</div>
                <div class="quarto-category">altair</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Migs Germar </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 31, 2021</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#preparations" id="toc-preparations" class="nav-link" data-scroll-target="#preparations">Preparations</a></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a>
  <ul class="collapse">
  <li><a href="#tables-and-views" id="toc-tables-and-views" class="nav-link" data-scroll-target="#tables-and-views">Tables and Views</a></li>
  <li><a href="#best-selling-music-genres-in-the-usa" id="toc-best-selling-music-genres-in-the-usa" class="nav-link" data-scroll-target="#best-selling-music-genres-in-the-usa">Best-Selling Music Genres in the USA</a></li>
  <li><a href="#sales-support-agent-performance" id="toc-sales-support-agent-performance" class="nav-link" data-scroll-target="#sales-support-agent-performance">Sales Support Agent Performance</a></li>
  <li><a href="#sales-data-by-country" id="toc-sales-data-by-country" class="nav-link" data-scroll-target="#sales-data-by-country">Sales Data by Country</a></li>
  <li><a href="#comparing-purchase-types-full-album-vs-selected-sets" id="toc-comparing-purchase-types-full-album-vs-selected-sets" class="nav-link" data-scroll-target="#comparing-purchase-types-full-album-vs-selected-sets">Comparing Purchase Types: Full Album vs Selected Sets</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/2021-07-31-music-shop.jfif" class="img-fluid figure-img"></p>
</figure>
</div>
<center>
<a href="https://unsplash.com/photos/fEVaiLwWvlU">Unsplash | Clay Banks</a>
</center>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>The <a href="https://github.com/lerocha/chinook-database">Chinook database</a> by Luis Rocha and Brice Lambson is a sample database about a hypothetical digital media store called Chinook. This store sells individual music tracks online, similar to iTunes. The database contains tables covering various aspects of the company, such as the employees, customers, invoices, tracks, albums, and artists.</p>
<p>The schema below, which was designed by Dataquest, lists the columns under each table. Columns connected by lines contain <strong>matching information</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/chinook-schema-dataquest.png" class="img-fluid figure-img"></p>
</figure>
</div>
<center>
<a href="https://app.dataquest.io/c/46/m/191/guided-project%3A-answering-business-questions-using-sql/1/introduction-and-schema-diagram">Image from Dataquest Guided Project: Answering Business Questions Using SQL</a>
</center>
<p><br></p>
<p>The matching columns allow us to perform joins on these tables. Thus, we are able to answer more complicated questions about the data.</p>
<p>In our hypothetical scenario, the Chinook company has requested us to answer the following business questions:</p>
<ul>
<li>What are the best-selling music genres with regards to USA customers? Based on this, which new albums should be purchased for the Chinook store?</li>
<li>Which of Chinook’s sales support agents has the highest total sales from their assigned customers? Can the exemplary performance of these employees be explained by any information in the database?</li>
<li>What are the statistics on the customers and sales for each country where Chinook offers its service?</li>
<li>How many purchases are full albums, and how many are selected sets of tracks? Based on this, what strategy should Chinook adopt when buying new tracks from record companies?</li>
</ul>
<p>SQL will be used to answer all of these questions. Matplotlib and Altair will also be used to produce helpful visualizations.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>I wrote this notebook by following a guided project on the <a href="https://www.dataquest.io/">Dataquest</a> platform, specifically the <a href="https://app.dataquest.io/c/46/m/191/guided-project%3A-answering-business-questions-using-sql/1/introduction-and-schema-diagram">Guided Project: Answering Business Questions Using SQL</a>. The general project flow and research questions came from Dataquest. However, the text and code here are written by me unless stated otherwise.</p>
</div>
</div>
</section>
<section id="preparations" class="level1">
<h1>Preparations</h1>
<p>Install the necessary packages.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Connect to the database using SQLite.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext sql</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>sql sqlite:<span class="op">///</span>private<span class="op">/</span><span class="dv">2021</span><span class="op">-</span><span class="dv">0</span><span class="er">7</span><span class="op">-</span><span class="dv">31</span><span class="op">-</span>Intermediate<span class="op">-</span>SQL<span class="op">-</span>Files<span class="op">/</span>chinook.db</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>'Connected: @private/2021-07-31-Intermediate-SQL-Files/chinook.db'</code></pre>
</div>
</div>
</section>
<section id="analysis" class="level1">
<h1>Analysis</h1>
<section id="tables-and-views" class="level2">
<h2 class="anchored" data-anchor-id="tables-and-views">Tables and Views</h2>
<p>First, we’ll inspect the tables and views available in the <code>chinook.db</code> database.</p>
<ul>
<li>Tables contain columns of data. Each column has a different name and data type.</li>
<li>Views do not contain data. Instead, these are pre-written SQL queries which show a transformation of existing data. Thus, it can be called a “virtual table.” (<a href="https://learnsql.com/blog/sql-view/">Sławińska 2020</a>)</li>
</ul>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>SELECT</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    name,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>FROM sqlite_master</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>WHERE <span class="bu">type</span> IN (<span class="st">"table"</span>, <span class="st">"view"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>album</td>
<td>table</td>
</tr>
<tr class="even">
<td>artist</td>
<td>table</td>
</tr>
<tr class="odd">
<td>customer</td>
<td>table</td>
</tr>
<tr class="even">
<td>employee</td>
<td>table</td>
</tr>
<tr class="odd">
<td>genre</td>
<td>table</td>
</tr>
<tr class="even">
<td>invoice</td>
<td>table</td>
</tr>
<tr class="odd">
<td>invoice_line</td>
<td>table</td>
</tr>
<tr class="even">
<td>media_type</td>
<td>table</td>
</tr>
<tr class="odd">
<td>playlist</td>
<td>table</td>
</tr>
<tr class="even">
<td>playlist_track</td>
<td>table</td>
</tr>
<tr class="odd">
<td>track</td>
<td>table</td>
</tr>
<tr class="even">
<td>usa_track_purchases</td>
<td>view</td>
</tr>
<tr class="odd">
<td>usa_genre_sales</td>
<td>view</td>
</tr>
<tr class="even">
<td>agent_customer</td>
<td>view</td>
</tr>
<tr class="odd">
<td>agent_stats</td>
<td>view</td>
</tr>
<tr class="even">
<td>country_invoices</td>
<td>view</td>
</tr>
<tr class="odd">
<td>country_customers</td>
<td>view</td>
</tr>
<tr class="even">
<td>country_labels</td>
<td>view</td>
</tr>
<tr class="odd">
<td>country_avg_order</td>
<td>view</td>
</tr>
<tr class="even">
<td>country_stats</td>
<td>view</td>
</tr>
<tr class="odd">
<td>invoice_tracks_bought</td>
<td>view</td>
</tr>
<tr class="even">
<td>invoice_album</td>
<td>view</td>
</tr>
<tr class="odd">
<td>invoice_full_album_tracks</td>
<td>view</td>
</tr>
<tr class="even">
<td>invoice_purchase_type</td>
<td>view</td>
</tr>
<tr class="odd">
<td>purchase_type_proportion</td>
<td>view</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Originally, there were only 11 tables and 0 views in the database. The views listed above are ones which I made throughout this project. I will show how I created these views in later sections.</p>
<p>For now, let’s inspect the <code>customer</code> table, as we will be using it to answer most of the company’s business questions.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>FROM customer</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">5</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">customer_id</th>
<th data-quarto-table-cell-role="th">first_name</th>
<th data-quarto-table-cell-role="th">last_name</th>
<th data-quarto-table-cell-role="th">company</th>
<th data-quarto-table-cell-role="th">address</th>
<th data-quarto-table-cell-role="th">city</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">postal_code</th>
<th data-quarto-table-cell-role="th">phone</th>
<th data-quarto-table-cell-role="th">fax</th>
<th data-quarto-table-cell-role="th">email</th>
<th data-quarto-table-cell-role="th">support_rep_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Luís</td>
<td>Gonçalves</td>
<td>Embraer - Empresa Brasileira de Aeronáutica S.A.</td>
<td>Av. Brigadeiro Faria Lima, 2170</td>
<td>São José dos Campos</td>
<td>SP</td>
<td>Brazil</td>
<td>12227-000</td>
<td>+55 (12) 3923-5555</td>
<td>+55 (12) 3923-5566</td>
<td>luisg@embraer.com.br</td>
<td>3</td>
</tr>
<tr class="even">
<td>2</td>
<td>Leonie</td>
<td>Köhler</td>
<td>None</td>
<td>Theodor-Heuss-Straße 34</td>
<td>Stuttgart</td>
<td>None</td>
<td>Germany</td>
<td>70174</td>
<td>+49 0711 2842222</td>
<td>None</td>
<td>leonekohler@surfeu.de</td>
<td>5</td>
</tr>
<tr class="odd">
<td>3</td>
<td>François</td>
<td>Tremblay</td>
<td>None</td>
<td>1498 rue Bélanger</td>
<td>Montréal</td>
<td>QC</td>
<td>Canada</td>
<td>H2G 1A7</td>
<td>+1 (514) 721-4711</td>
<td>None</td>
<td>ftremblay@gmail.com</td>
<td>3</td>
</tr>
<tr class="even">
<td>4</td>
<td>Bjørn</td>
<td>Hansen</td>
<td>None</td>
<td>Ullevålsveien 14</td>
<td>Oslo</td>
<td>None</td>
<td>Norway</td>
<td>0171</td>
<td>+47 22 44 22 22</td>
<td>None</td>
<td>bjorn.hansen@yahoo.no</td>
<td>4</td>
</tr>
<tr class="odd">
<td>5</td>
<td>František</td>
<td>Wichterlová</td>
<td>JetBrains s.r.o.</td>
<td>Klanova 9/506</td>
<td>Prague</td>
<td>None</td>
<td>Czech Republic</td>
<td>14700</td>
<td>+420 2 4172 5555</td>
<td>+420 2 4172 5555</td>
<td>frantisekw@jetbrains.com</td>
<td>4</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Each row in this table contains data on a different customer of Chinook. Each customer has a unique customer ID and an assigned support representative from Chinook. The support rep’s employee ID is stored in the <code>support_rep_id</code> column. The other columns contain information on the customer’s name, occupation, location, and contact details.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>All names and personal details in the Chinook database are fictitious and randomly generated. Public use of this database is not a breach of data privacy.</p>
</div>
</div>
</section>
<section id="best-selling-music-genres-in-the-usa" class="level2">
<h2 class="anchored" data-anchor-id="best-selling-music-genres-in-the-usa">Best-Selling Music Genres in the USA</h2>
<p>In our first scenario, Chinook has signed a deal with a new record company, so its tracks can now be put up for sale on the Chinook store. The record company has 4 albums so far; below are the artist names and their genres.</p>
<ul>
<li>Regal (Hip-Hop)</li>
<li>Red Tone (Punk)</li>
<li>Meteor and the Girls (Pop)</li>
<li>Slim Jim Bites (Blues)</li>
</ul>
<p>However, Chinook would like to spread its releases over time, so it will only add 3 albums to the store. Thus, we have to determine the best-selling genres on the store. Furthermore, since the record company would like to target a USA audience, we can narrow our analysis to Chinook’s USA customers.</p>
<p>First, we create a view called <code>usa_track_purchases</code>. This will show the genre, track name, unit price, and quantity bought for each of the invoice lines of USA customers.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS usa_track_purchases<span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW usa_track_purchases AS</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        il.invoice_line_id AS invoice_line_id,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        g.name AS genre,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        t.name AS track_name,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        il.unit_price AS unit_price,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        il.quantity AS quantity</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    FROM customer AS c</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        invoice AS iv</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        ON iv.customer_id <span class="op">=</span> c.customer_id</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        invoice_line AS il</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        ON il.invoice_id <span class="op">=</span> iv.invoice_id</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        track AS t</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        ON t.track_id <span class="op">=</span> il.track_id</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        genre AS g</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        ON g.genre_id <span class="op">=</span> t.genre_id</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    WHERE c.country <span class="op">=</span> <span class="st">"USA"</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>FROM usa_track_purchases</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">7</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">invoice_line_id</th>
<th data-quarto-table-cell-role="th">genre</th>
<th data-quarto-table-cell-role="th">track_name</th>
<th data-quarto-table-cell-role="th">unit_price</th>
<th data-quarto-table-cell-role="th">quantity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Rock</td>
<td>Right Next Door to Hell</td>
<td>0.99</td>
<td>1</td>
</tr>
<tr class="even">
<td>2</td>
<td>Rock</td>
<td>Dust N' Bones</td>
<td>0.99</td>
<td>1</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Rock</td>
<td>Live and Let Die</td>
<td>0.99</td>
<td>1</td>
</tr>
<tr class="even">
<td>4</td>
<td>Rock</td>
<td>Don't Cry (Original)</td>
<td>0.99</td>
<td>1</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Rock</td>
<td>Perfect Crime</td>
<td>0.99</td>
<td>1</td>
</tr>
<tr class="even">
<td>6</td>
<td>Rock</td>
<td>You Ain't the First</td>
<td>0.99</td>
<td>1</td>
</tr>
<tr class="odd">
<td>7</td>
<td>Rock</td>
<td>Bad Obsession</td>
<td>0.99</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>By querying the view above, we will create another view, <code>usa_genre_sales</code>. This will contain the following specific information about each genre:</p>
<ul>
<li>Number of tracks sold</li>
<li>Percentage of tracks sold</li>
<li>Total sales in US dollars</li>
</ul>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS usa_genre_sales<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW usa_genre_sales AS</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        genre,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        SUM(quantity) AS number_sold,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>Get the quantity per genre <span class="kw">and</span> divide it by the total quantity of USA purchases.</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        ROUND(</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>            CAST(SUM(quantity) AS Float)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">/</span> CAST(</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                (SELECT COUNT(<span class="op">*</span>) FROM usa_track_purchases)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                AS Float</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span> <span class="fl">100.0</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        ) AS percentage_sold,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        ROUND(</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>            SUM(unit_price <span class="op">*</span> CAST(quantity AS Float)),</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        ) AS total_sales</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    FROM usa_track_purchases</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    GROUP BY genre</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    ORDER BY number_sold DESC, total_sales DESC</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>[]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql result <span class="op">&lt;&lt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>FROM usa_genre_sales</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Returning data to local variable result</code></pre>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>usa_genre_df <span class="op">=</span> result.DataFrame()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>usa_genre_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">genre</th>
<th data-quarto-table-cell-role="th">number_sold</th>
<th data-quarto-table-cell-role="th">percentage_sold</th>
<th data-quarto-table-cell-role="th">total_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Rock</td>
<td>561</td>
<td>53.38</td>
<td>555.39</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Alternative &amp; Punk</td>
<td>130</td>
<td>12.37</td>
<td>128.70</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Metal</td>
<td>124</td>
<td>11.80</td>
<td>122.76</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>R&amp;B/Soul</td>
<td>53</td>
<td>5.04</td>
<td>52.47</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Blues</td>
<td>36</td>
<td>3.43</td>
<td>35.64</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Alternative</td>
<td>35</td>
<td>3.33</td>
<td>34.65</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Latin</td>
<td>22</td>
<td>2.09</td>
<td>21.78</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Pop</td>
<td>22</td>
<td>2.09</td>
<td>21.78</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Hip Hop/Rap</td>
<td>20</td>
<td>1.90</td>
<td>19.80</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Jazz</td>
<td>14</td>
<td>1.33</td>
<td>13.86</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Easy Listening</td>
<td>13</td>
<td>1.24</td>
<td>12.87</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Reggae</td>
<td>6</td>
<td>0.57</td>
<td>5.94</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Electronica/Dance</td>
<td>5</td>
<td>0.48</td>
<td>4.95</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>Classical</td>
<td>4</td>
<td>0.38</td>
<td>3.96</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Heavy Metal</td>
<td>3</td>
<td>0.29</td>
<td>2.97</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>Soundtrack</td>
<td>2</td>
<td>0.19</td>
<td>1.98</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>TV Shows</td>
<td>1</td>
<td>0.10</td>
<td>0.99</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can make a bar graph from this result in order to communicate findings better.</p>
<div class="cell" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    alt.Chart(usa_genre_df)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    .mark_bar()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    .encode(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> alt.X(<span class="st">"genre:N"</span>, title <span class="op">=</span> <span class="st">"Music Genre"</span>, sort <span class="op">=</span> <span class="st">"-y"</span>),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> alt.Y(<span class="st">"percentage_sold:Q"</span>, title <span class="op">=</span> <span class="st">"Percentage of All Purchases in the USA"</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> alt.Color(<span class="st">"total_sales:Q"</span>, title <span class="op">=</span> <span class="st">"Total Sales (USD)"</span>),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        tooltip <span class="op">=</span> usa_genre_df.columns.tolist(),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    .properties(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Popularity of Music Genres with Chinook's USA Customers"</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> <span class="dv">300</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        width <span class="op">=</span> <span class="dv">600</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    .configure_axis(</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        labelAngle <span class="op">=</span> <span class="dv">30</span>,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    .interactive()</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">

<div id="altair-viz-92ed8978cd6a4d7ab6232c47eaaa9281"></div>
<script type="text/javascript">
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-92ed8978cd6a4d7ab6232c47eaaa9281") {
      outputDiv = document.getElementById("altair-viz-92ed8978cd6a4d7ab6232c47eaaa9281");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.8.1?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function loadScript(lib) {
      return new Promise(function(resolve, reject) {
        var s = document.createElement('script');
        s.src = paths[lib];
        s.async = true;
        s.onload = () => resolve(paths[lib]);
        s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
        document.getElementsByTagName("head")[0].appendChild(s);
      });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else if (typeof vegaEmbed === "function") {
      displayChart(vegaEmbed);
    } else {
      loadScript("vega")
        .then(() => loadScript("vega-lite"))
        .then(() => loadScript("vega-embed"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}, "axis": {"labelAngle": 30}}, "data": {"name": "data-efd7bdfa4680b65be149f0a063c6d6e7"}, "mark": "bar", "encoding": {"color": {"type": "quantitative", "field": "total_sales", "title": "Total Sales (USD)"}, "tooltip": [{"type": "nominal", "field": "genre"}, {"type": "quantitative", "field": "number_sold"}, {"type": "quantitative", "field": "percentage_sold"}, {"type": "quantitative", "field": "total_sales"}], "x": {"type": "nominal", "field": "genre", "sort": "-y", "title": "Music Genre"}, "y": {"type": "quantitative", "field": "percentage_sold", "title": "Percentage of All Purchases in the USA"}}, "height": 300, "selection": {"selector001": {"type": "interval", "bind": "scales", "encodings": ["x", "y"]}}, "title": "Popularity of Music Genres with Chinook's USA Customers", "width": 600, "$schema": "https://vega.github.io/schema/vega-lite/v4.8.1.json", "datasets": {"data-efd7bdfa4680b65be149f0a063c6d6e7": [{"genre": "Rock", "number_sold": 561, "percentage_sold": 53.38, "total_sales": 555.39}, {"genre": "Alternative & Punk", "number_sold": 130, "percentage_sold": 12.37, "total_sales": 128.7}, {"genre": "Metal", "number_sold": 124, "percentage_sold": 11.8, "total_sales": 122.76}, {"genre": "R&B/Soul", "number_sold": 53, "percentage_sold": 5.04, "total_sales": 52.47}, {"genre": "Blues", "number_sold": 36, "percentage_sold": 3.43, "total_sales": 35.64}, {"genre": "Alternative", "number_sold": 35, "percentage_sold": 3.33, "total_sales": 34.65}, {"genre": "Latin", "number_sold": 22, "percentage_sold": 2.09, "total_sales": 21.78}, {"genre": "Pop", "number_sold": 22, "percentage_sold": 2.09, "total_sales": 21.78}, {"genre": "Hip Hop/Rap", "number_sold": 20, "percentage_sold": 1.9, "total_sales": 19.8}, {"genre": "Jazz", "number_sold": 14, "percentage_sold": 1.33, "total_sales": 13.86}, {"genre": "Easy Listening", "number_sold": 13, "percentage_sold": 1.24, "total_sales": 12.87}, {"genre": "Reggae", "number_sold": 6, "percentage_sold": 0.57, "total_sales": 5.94}, {"genre": "Electronica/Dance", "number_sold": 5, "percentage_sold": 0.48, "total_sales": 4.95}, {"genre": "Classical", "number_sold": 4, "percentage_sold": 0.38, "total_sales": 3.96}, {"genre": "Heavy Metal", "number_sold": 3, "percentage_sold": 0.29, "total_sales": 2.97}, {"genre": "Soundtrack", "number_sold": 2, "percentage_sold": 0.19, "total_sales": 1.98}, {"genre": "TV Shows", "number_sold": 1, "percentage_sold": 0.1, "total_sales": 0.99}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<p>One can hover over each bar in the chart above for a tooltip with more specific information.</p>
<p>Results show that Rock is the best-selling music genre as it makes up 53% of total purchases in the USA. Rock is followed by the Alternative &amp; Punk and Metal genres, which each make up over 10% of purchases.</p>
<p>On a side note, the <code>total_sales</code> column’s values are very close to that of the <code>number_sold</code> column. This can be explained by the fact that track prices range from USD 0.99 to USD 1.99.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>SELECT</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    MIN(unit_price) AS min_price,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    MAX(unit_price) AS max_price</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>FROM track</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">min_price</th>
<th data-quarto-table-cell-role="th">max_price</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.99</td>
<td>1.99</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Since there is little variation among track prices, the genre with the most units sold is usually also the genre with the highest sales.</p>
<p>Going back to the scenario at hand, we need to compare the statistics on the Hip-Hop, Punk, Pop, and Blues genres. We will run a query for this below.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>FROM usa_genre_sales</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>WHERE genre IN (<span class="st">"Hip Hop/Rap"</span>, <span class="st">"Alternative &amp; Punk"</span>, <span class="st">"Pop"</span>, <span class="st">"Blues"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">genre</th>
<th data-quarto-table-cell-role="th">number_sold</th>
<th data-quarto-table-cell-role="th">percentage_sold</th>
<th data-quarto-table-cell-role="th">total_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Alternative &amp; Punk</td>
<td>130</td>
<td>12.37</td>
<td>128.7</td>
</tr>
<tr class="even">
<td>Blues</td>
<td>36</td>
<td>3.43</td>
<td>35.64</td>
</tr>
<tr class="odd">
<td>Pop</td>
<td>22</td>
<td>2.09</td>
<td>21.78</td>
</tr>
<tr class="even">
<td>Hip Hop/Rap</td>
<td>20</td>
<td>1.9</td>
<td>19.8</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The result above shows that Alternative &amp; Punk, Blues, and Pop are the three best-selling genres out of the four. Notably, Alternative &amp; Punk makes up 12.37% of all purchases in the USA.</p>
<p>Therefore, we would recommend the Chinook administration to add the albums of <strong>Red Tone (Punk), Slim Jim Bites (Blues), and Meteor and the Girls (Pop)</strong> to the digital store. The album of Regal (Hip-Hop) has lower priority and can be added at a later date.</p>
</section>
<section id="sales-support-agent-performance" class="level2">
<h2 class="anchored" data-anchor-id="sales-support-agent-performance">Sales Support Agent Performance</h2>
<p>Next, Chinook is requesting us to evaluate the performance of its sales support agents. Each customer is assigned to an agent after their first purchase. Since there are only 3 agents, each agent provides support to many customers. Details about the agents are shown in the query below.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>FROM employee</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>WHERE title <span class="op">=</span> <span class="st">"Sales Support Agent"</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">employee_id</th>
<th data-quarto-table-cell-role="th">last_name</th>
<th data-quarto-table-cell-role="th">first_name</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">reports_to</th>
<th data-quarto-table-cell-role="th">birthdate</th>
<th data-quarto-table-cell-role="th">hire_date</th>
<th data-quarto-table-cell-role="th">address</th>
<th data-quarto-table-cell-role="th">city</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">postal_code</th>
<th data-quarto-table-cell-role="th">phone</th>
<th data-quarto-table-cell-role="th">fax</th>
<th data-quarto-table-cell-role="th">email</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>Peacock</td>
<td>Jane</td>
<td>Sales Support Agent</td>
<td>2</td>
<td>1973-08-29 00:00:00</td>
<td>2017-04-01 00:00:00</td>
<td>1111 6 Ave SW</td>
<td>Calgary</td>
<td>AB</td>
<td>Canada</td>
<td>T2P 5M5</td>
<td>+1 (403) 262-3443</td>
<td>+1 (403) 262-6712</td>
<td>jane@chinookcorp.com</td>
</tr>
<tr class="even">
<td>4</td>
<td>Park</td>
<td>Margaret</td>
<td>Sales Support Agent</td>
<td>2</td>
<td>1947-09-19 00:00:00</td>
<td>2017-05-03 00:00:00</td>
<td>683 10 Street SW</td>
<td>Calgary</td>
<td>AB</td>
<td>Canada</td>
<td>T2P 5G3</td>
<td>+1 (403) 263-4423</td>
<td>+1 (403) 263-4289</td>
<td>margaret@chinookcorp.com</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Johnson</td>
<td>Steve</td>
<td>Sales Support Agent</td>
<td>2</td>
<td>1965-03-03 00:00:00</td>
<td>2017-10-17 00:00:00</td>
<td>7727B 41 Ave</td>
<td>Calgary</td>
<td>AB</td>
<td>Canada</td>
<td>T3B 1Y7</td>
<td>1 (780) 836-9987</td>
<td>1 (780) 836-9543</td>
<td>steve@chinookcorp.com</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Since we have data on each customer’s purchases, we can calculate the total purchases associated with each support agent. We can then use this to compare the performance of the agents.</p>
<p>First, we create a view called <code>agent_customer</code> by joining the <code>employee</code> table with the <code>customer</code> table based on the support representative ID. We will include some extra details about each agent, such as their birthdate and hire date. We won’t include their location since we know that they are all in Calgary, AB, Canada. As for the customers, we will include their customer ID, name, and total purchases as the sum of their invoices.</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS agent_customer<span class="op">;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW agent_customer AS</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        e.employee_id AS agent_id,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        e.first_name <span class="op">||</span> <span class="st">" "</span> <span class="op">||</span> e.last_name AS agent_name,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        e.birthdate AS agent_bd,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        e.hire_date AS agent_hire_date,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        c.customer_id AS customer_id,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        c.first_name <span class="op">||</span> <span class="st">" "</span> <span class="op">||</span> c.last_name AS customer_name,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        SUM(iv.total) AS customer_total_purchases</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    FROM employee AS e</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    LEFT JOIN</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        customer AS c</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        ON c.support_rep_id <span class="op">=</span> e.employee_id</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    LEFT JOIN</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        invoice AS iv</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        ON iv.customer_id <span class="op">=</span> c.customer_id</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    WHERE e.title <span class="op">=</span> <span class="st">"Sales Support Agent"</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    GROUP BY c.customer_id</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    ORDER BY agent_id, customer_id</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>[]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql result <span class="op">&lt;&lt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>FROM agent_customer</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Returning data to local variable result</code></pre>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>agent_customer_df <span class="op">=</span> result.DataFrame()</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>agent_customer_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">agent_id</th>
<th data-quarto-table-cell-role="th">agent_name</th>
<th data-quarto-table-cell-role="th">agent_bd</th>
<th data-quarto-table-cell-role="th">agent_hire_date</th>
<th data-quarto-table-cell-role="th">customer_id</th>
<th data-quarto-table-cell-role="th">customer_name</th>
<th data-quarto-table-cell-role="th">customer_total_purchases</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>3</td>
<td>Jane Peacock</td>
<td>1973-08-29 00:00:00</td>
<td>2017-04-01 00:00:00</td>
<td>1</td>
<td>Luís Gonçalves</td>
<td>108.90</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3</td>
<td>Jane Peacock</td>
<td>1973-08-29 00:00:00</td>
<td>2017-04-01 00:00:00</td>
<td>3</td>
<td>François Tremblay</td>
<td>99.99</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>Jane Peacock</td>
<td>1973-08-29 00:00:00</td>
<td>2017-04-01 00:00:00</td>
<td>12</td>
<td>Roberto Almeida</td>
<td>82.17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>Jane Peacock</td>
<td>1973-08-29 00:00:00</td>
<td>2017-04-01 00:00:00</td>
<td>15</td>
<td>Jennifer Peterson</td>
<td>66.33</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3</td>
<td>Jane Peacock</td>
<td>1973-08-29 00:00:00</td>
<td>2017-04-01 00:00:00</td>
<td>18</td>
<td>Michelle Brooks</td>
<td>79.20</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Next, we will query this view in order to determine the following information about each agent:</p>
<ul>
<li>number of customers</li>
<li>total sales from the agent’s customers</li>
<li>percentage of all agents’ sales</li>
<li>average sales per customer</li>
</ul>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS agent_stats<span class="op">;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW agent_stats AS</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        agent_id,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        agent_name,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        agent_bd,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        agent_hire_date,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        COUNT(customer_id) AS number_customers,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        ROUND(</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>            SUM(customer_total_purchases),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        ) AS sales_number,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        ROUND(</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>            SUM(customer_total_purchases) </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">/</span> (SELECT SUM(customer_total_purchases) FROM agent_customer)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>        )AS sales_percentage,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        ROUND(</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>            AVG(customer_total_purchases),</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>        ) AS average_per_customer</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    FROM agent_customer</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    GROUP BY agent_id</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>FROM agent_stats</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="16">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">agent_id</th>
<th data-quarto-table-cell-role="th">agent_name</th>
<th data-quarto-table-cell-role="th">agent_bd</th>
<th data-quarto-table-cell-role="th">agent_hire_date</th>
<th data-quarto-table-cell-role="th">number_customers</th>
<th data-quarto-table-cell-role="th">sales_number</th>
<th data-quarto-table-cell-role="th">sales_percentage</th>
<th data-quarto-table-cell-role="th">average_per_customer</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>Jane Peacock</td>
<td>1973-08-29 00:00:00</td>
<td>2017-04-01 00:00:00</td>
<td>21</td>
<td>1731.51</td>
<td>36.77</td>
<td>82.45</td>
</tr>
<tr class="even">
<td>4</td>
<td>Margaret Park</td>
<td>1947-09-19 00:00:00</td>
<td>2017-05-03 00:00:00</td>
<td>20</td>
<td>1584.0</td>
<td>33.63</td>
<td>79.2</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Steve Johnson</td>
<td>1965-03-03 00:00:00</td>
<td>2017-10-17 00:00:00</td>
<td>18</td>
<td>1393.92</td>
<td>29.6</td>
<td>77.44</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>At first glance, Jane Peacock seems like the best-performing agent since Chinook got the highest total sales from her customers (USD 1731.51). This idea is cast into doubt when it is mentioned that she had the highest number of customers (21).</p>
<p>Also, the differences among the average sales per customer is quite small. Each of Jane’s customers spends 3 more dollars on Chinook than each of Margaret’s. Each of Margaret’s customers spends 2 more dollars on Chinook than each of Steve Johnson’s.</p>
<p>The average sales per customer may also be influenced by outliers, as shown by the boxplot below.</p>
<div class="cell" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    alt.Chart(agent_customer_df)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    .mark_boxplot()</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    .encode(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> alt.Y(<span class="st">"customer_total_purchases:Q"</span>, title <span class="op">=</span> <span class="st">"Customer Total Purchases"</span>),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> alt.X(<span class="st">"agent_name:N"</span>, title <span class="op">=</span> <span class="st">"Agent Name"</span>),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    .properties(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Distribution of Customer Purchases by Sales Support Agent"</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> <span class="dv">300</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        width <span class="op">=</span> <span class="dv">500</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    .interactive()</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="17">

<div id="altair-viz-5b69273df5cd4a5c85aae96249fbd5a7"></div>
<script type="text/javascript">
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-5b69273df5cd4a5c85aae96249fbd5a7") {
      outputDiv = document.getElementById("altair-viz-5b69273df5cd4a5c85aae96249fbd5a7");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.8.1?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function loadScript(lib) {
      return new Promise(function(resolve, reject) {
        var s = document.createElement('script');
        s.src = paths[lib];
        s.async = true;
        s.onload = () => resolve(paths[lib]);
        s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
        document.getElementsByTagName("head")[0].appendChild(s);
      });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else if (typeof vegaEmbed === "function") {
      displayChart(vegaEmbed);
    } else {
      loadScript("vega")
        .then(() => loadScript("vega-lite"))
        .then(() => loadScript("vega-embed"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"name": "data-543360b264d950faaeb0d2fc6b725054"}, "mark": "boxplot", "encoding": {"x": {"type": "nominal", "field": "agent_name", "title": "Agent Name"}, "y": {"type": "quantitative", "field": "customer_total_purchases", "title": "Customer Total Purchases"}}, "height": 300, "selection": {"selector002": {"type": "interval", "bind": "scales", "encodings": ["x", "y"]}}, "title": "Distribution of Customer Purchases by Sales Support Agent", "width": 500, "$schema": "https://vega.github.io/schema/vega-lite/v4.8.1.json", "datasets": {"data-543360b264d950faaeb0d2fc6b725054": [{"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 1, "customer_name": "Lu\u00eds Gon\u00e7alves", "customer_total_purchases": 108.89999999999998}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 3, "customer_name": "Fran\u00e7ois Tremblay", "customer_total_purchases": 99.99}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 12, "customer_name": "Roberto Almeida", "customer_total_purchases": 82.17}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 15, "customer_name": "Jennifer Peterson", "customer_total_purchases": 66.33}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 18, "customer_name": "Michelle Brooks", "customer_total_purchases": 79.2}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 19, "customer_name": "Tim Goyer", "customer_total_purchases": 54.449999999999996}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 24, "customer_name": "Frank Ralston", "customer_total_purchases": 71.28}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 29, "customer_name": "Robert Brown", "customer_total_purchases": 40.59}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 30, "customer_name": "Edward Francis", "customer_total_purchases": 91.08}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 33, "customer_name": "Ellie Sullivan", "customer_total_purchases": 75.24000000000001}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 37, "customer_name": "Fynn Zimmermann", "customer_total_purchases": 94.05000000000001}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 38, "customer_name": "Niklas Schr\u00f6der", "customer_total_purchases": 73.25999999999999}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 42, "customer_name": "Wyatt Girard", "customer_total_purchases": 99.99}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 43, "customer_name": "Isabelle Mercier", "customer_total_purchases": 73.25999999999999}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 44, "customer_name": "Terhi H\u00e4m\u00e4l\u00e4inen", "customer_total_purchases": 79.2}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 45, "customer_name": "Ladislav Kov\u00e1cs", "customer_total_purchases": 78.21}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 46, "customer_name": "Hugh O'Reilly", "customer_total_purchases": 114.83999999999997}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 52, "customer_name": "Emma Jones", "customer_total_purchases": 68.31}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 53, "customer_name": "Phil Hughes", "customer_total_purchases": 98.01}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 58, "customer_name": "Manoj Pareek", "customer_total_purchases": 111.86999999999999}, {"agent_id": 3, "agent_name": "Jane Peacock", "agent_bd": "1973-08-29 00:00:00", "agent_hire_date": "2017-04-01 00:00:00", "customer_id": 59, "customer_name": "Puja Srivastava", "customer_total_purchases": 71.28}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 4, "customer_name": "Bj\u00f8rn Hansen", "customer_total_purchases": 72.27000000000001}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 5, "customer_name": "Franti\u0161ek Wichterlov\u00e1", "customer_total_purchases": 144.54000000000002}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 8, "customer_name": "Daan Peeters", "customer_total_purchases": 60.38999999999999}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 9, "customer_name": "Kara Nielsen", "customer_total_purchases": 37.61999999999999}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 10, "customer_name": "Eduardo Martins", "customer_total_purchases": 60.39}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 13, "customer_name": "Fernanda Ramos", "customer_total_purchases": 106.91999999999999}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 16, "customer_name": "Frank Harris", "customer_total_purchases": 74.25}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 20, "customer_name": "Dan Miller", "customer_total_purchases": 95.03999999999999}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 22, "customer_name": "Heather Leacock", "customer_total_purchases": 92.07000000000001}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 23, "customer_name": "John Gordon", "customer_total_purchases": 66.33}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 26, "customer_name": "Richard Cunningham", "customer_total_purchases": 86.13000000000002}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 27, "customer_name": "Patrick Gray", "customer_total_purchases": 84.14999999999999}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 32, "customer_name": "Aaron Mitchell", "customer_total_purchases": 70.28999999999999}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 34, "customer_name": "Jo\u00e3o Fernandes", "customer_total_purchases": 102.96000000000001}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 35, "customer_name": "Madalena Sampaio", "customer_total_purchases": 82.17}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 39, "customer_name": "Camille Bernard", "customer_total_purchases": 79.2}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 40, "customer_name": "Dominique Lefebvre", "customer_total_purchases": 72.27}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 49, "customer_name": "Stanis\u0142aw W\u00f3jcik", "customer_total_purchases": 76.22999999999999}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 55, "customer_name": "Mark Taylor", "customer_total_purchases": 81.18}, {"agent_id": 4, "agent_name": "Margaret Park", "agent_bd": "1947-09-19 00:00:00", "agent_hire_date": "2017-05-03 00:00:00", "customer_id": 56, "customer_name": "Diego Guti\u00e9rrez", "customer_total_purchases": 39.6}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 2, "customer_name": "Leonie K\u00f6hler", "customer_total_purchases": 82.17}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 6, "customer_name": "Helena Hol\u00fd", "customer_total_purchases": 128.7}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 7, "customer_name": "Astrid Gruber", "customer_total_purchases": 69.3}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 11, "customer_name": "Alexandre Rocha", "customer_total_purchases": 69.3}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 14, "customer_name": "Mark Philips", "customer_total_purchases": 29.699999999999996}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 17, "customer_name": "Jack Smith", "customer_total_purchases": 98.01}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 21, "customer_name": "Kathy Chase", "customer_total_purchases": 91.08000000000001}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 25, "customer_name": "Victor Stevens", "customer_total_purchases": 76.23}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 28, "customer_name": "Julia Barnett", "customer_total_purchases": 72.27}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 31, "customer_name": "Martha Silk", "customer_total_purchases": 62.370000000000005}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 36, "customer_name": "Hannah Schneider", "customer_total_purchases": 85.14}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 41, "customer_name": "Marc Dubois", "customer_total_purchases": 64.35}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 47, "customer_name": "Lucas Mancini", "customer_total_purchases": 50.49}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 48, "customer_name": "Johannes Van der Berg", "customer_total_purchases": 65.34}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 50, "customer_name": "Enrique Mu\u00f1oz", "customer_total_purchases": 98.01}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 51, "customer_name": "Joakim Johansson", "customer_total_purchases": 75.24}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 54, "customer_name": "Steve Murray", "customer_total_purchases": 79.2}, {"agent_id": 5, "agent_name": "Steve Johnson", "agent_bd": "1965-03-03 00:00:00", "agent_hire_date": "2017-10-17 00:00:00", "customer_id": 57, "customer_name": "Luis Rojas", "customer_total_purchases": 97.02000000000001}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<p>If we hover over each of the boxes above, we can get more information such as minimum, 1st quartile, median, etc. The median is less influenced by outliers, so we can look at that. The median values are 79.20 (Jane), 77.72 (Margaret), and 75.74 (Steve). These values are still very close to each other.</p>
<p>Therefore, we cannot conclusively state that any agent performs better than the others.</p>
</section>
<section id="sales-data-by-country" class="level2">
<h2 class="anchored" data-anchor-id="sales-data-by-country">Sales Data by Country</h2>
<p>Next, Chinook is requesting us to analyze sales in each country where it offers its service. Specifically, they would like to know the:</p>
<ul>
<li>total number of customers</li>
<li>total value of sales</li>
<li>average sales per customer</li>
<li>average order value
<ul>
<li>Every order is a batch purchase of multiple tracks.</li>
</ul></li>
</ul>
<p>Furthermore, since there are some countries in the database with only one customer, we shall group these customers together under a category called “Other”, which must appear at the very bottom of our final result.</p>
<p>First, we will create a view, <code>country_invoices</code>, which shows all invoices and the country of the customer.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS country_invoices<span class="op">;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW country_invoices AS</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        c.country AS country,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        c.customer_id AS customer_id,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        c.first_name <span class="op">||</span> <span class="st">" "</span> <span class="op">||</span> c.last_name AS customer_name,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        iv.invoice_id AS invoice_id,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        iv.total AS order_value</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    FROM customer AS c</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    LEFT JOIN</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        invoice AS iv</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        ON iv.customer_id <span class="op">=</span> c.customer_id</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>FROM country_invoices</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">5</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">customer_id</th>
<th data-quarto-table-cell-role="th">customer_name</th>
<th data-quarto-table-cell-role="th">invoice_id</th>
<th data-quarto-table-cell-role="th">order_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Brazil</td>
<td>1</td>
<td>Luís Gonçalves</td>
<td>16</td>
<td>8.91</td>
</tr>
<tr class="even">
<td>Brazil</td>
<td>1</td>
<td>Luís Gonçalves</td>
<td>77</td>
<td>5.9399999999999995</td>
</tr>
<tr class="odd">
<td>Brazil</td>
<td>1</td>
<td>Luís Gonçalves</td>
<td>149</td>
<td>8.91</td>
</tr>
<tr class="even">
<td>Brazil</td>
<td>1</td>
<td>Luís Gonçalves</td>
<td>153</td>
<td>13.86</td>
</tr>
<tr class="odd">
<td>Brazil</td>
<td>1</td>
<td>Luís Gonçalves</td>
<td>182</td>
<td>5.9399999999999995</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Then, we will create a view, <code>country_customers</code>, which shows the total purchases per customer.</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS country_customers<span class="op">;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW country_customers AS</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        country,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        customer_id,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>        customer_name,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        SUM(order_value) AS customer_total_purchase</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    FROM country_invoices</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    GROUP BY customer_id</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>FROM country_customers</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">5</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">customer_id</th>
<th data-quarto-table-cell-role="th">customer_name</th>
<th data-quarto-table-cell-role="th">customer_total_purchase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Brazil</td>
<td>1</td>
<td>Luís Gonçalves</td>
<td>108.89999999999998</td>
</tr>
<tr class="even">
<td>Germany</td>
<td>2</td>
<td>Leonie Köhler</td>
<td>82.17</td>
</tr>
<tr class="odd">
<td>Canada</td>
<td>3</td>
<td>François Tremblay</td>
<td>99.99</td>
</tr>
<tr class="even">
<td>Norway</td>
<td>4</td>
<td>Bjørn Hansen</td>
<td>72.27000000000001</td>
</tr>
<tr class="odd">
<td>Czech Republic</td>
<td>5</td>
<td>František Wichterlová</td>
<td>144.54000000000002</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We will then create a view called <code>country_labels</code>. It will show the number of customers per country. Countries with only 1 customer will be given a label of “Other”.</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS country_labels<span class="op">;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW country_labels AS</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        country,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        COUNT(customer_id) AS number_customers,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        CASE</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>            WHEN COUNT(customer_id) <span class="op">&gt;</span> <span class="dv">1</span> THEN country</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>            ELSE <span class="st">"Other"</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>            END AS country_label,</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        CASE</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>            WHEN COUNT(customer_id) <span class="op">&gt;</span> <span class="dv">1</span> THEN <span class="dv">0</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>            ELSE <span class="dv">1</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>            END AS is_other</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    FROM country_customers</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    GROUP BY country</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>FROM country_labels</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">10</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">number_customers</th>
<th data-quarto-table-cell-role="th">country_label</th>
<th data-quarto-table-cell-role="th">is_other</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Argentina</td>
<td>1</td>
<td>Other</td>
<td>1</td>
</tr>
<tr class="even">
<td>Australia</td>
<td>1</td>
<td>Other</td>
<td>1</td>
</tr>
<tr class="odd">
<td>Austria</td>
<td>1</td>
<td>Other</td>
<td>1</td>
</tr>
<tr class="even">
<td>Belgium</td>
<td>1</td>
<td>Other</td>
<td>1</td>
</tr>
<tr class="odd">
<td>Brazil</td>
<td>5</td>
<td>Brazil</td>
<td>0</td>
</tr>
<tr class="even">
<td>Canada</td>
<td>8</td>
<td>Canada</td>
<td>0</td>
</tr>
<tr class="odd">
<td>Chile</td>
<td>1</td>
<td>Other</td>
<td>1</td>
</tr>
<tr class="even">
<td>Czech Republic</td>
<td>2</td>
<td>Czech Republic</td>
<td>0</td>
</tr>
<tr class="odd">
<td>Denmark</td>
<td>1</td>
<td>Other</td>
<td>1</td>
</tr>
<tr class="even">
<td>Finland</td>
<td>1</td>
<td>Other</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We will also create a view called <code>country_avg_order</code> which simply shows the average order value per country. This will be done by querying the <code>country_invoices</code> view.</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS country_avg_order<span class="op">;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW country_avg_order AS</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        cl.country_label,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>        AVG(civ.order_value) AS avg_order_value</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    FROM country_invoices AS civ</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        country_labels AS cl</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        ON cl.country <span class="op">=</span> civ.country</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    GROUP BY cl.country_label</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>FROM country_avg_order</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">country_label</th>
<th data-quarto-table-cell-role="th">avg_order_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Brazil</td>
<td>7.011147540983605</td>
</tr>
<tr class="even">
<td>Canada</td>
<td>7.047236842105264</td>
</tr>
<tr class="odd">
<td>Czech Republic</td>
<td>9.107999999999999</td>
</tr>
<tr class="even">
<td>France</td>
<td>7.781400000000001</td>
</tr>
<tr class="odd">
<td>Germany</td>
<td>8.161463414634145</td>
</tr>
<tr class="even">
<td>India</td>
<td>8.72142857142857</td>
</tr>
<tr class="odd">
<td>Other</td>
<td>7.44857142857143</td>
</tr>
<tr class="even">
<td>Portugal</td>
<td>6.3837931034482756</td>
</tr>
<tr class="odd">
<td>USA</td>
<td>7.942671755725194</td>
</tr>
<tr class="even">
<td>United Kingdom</td>
<td>8.768571428571429</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Finally, we will create a view called <code>country_stats</code> that shows all of the 4 statistics that were requested by the Chinook management. The “Other” entry will be forced to the bottom of the query result using the <code>is_other</code> column we created in the <code>country_labels</code> view.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS country_stats<span class="op">;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW country_stats AS</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        l.country_label,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        COUNT(c.customer_id) AS number_customers,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        ROUND(SUM(c.customer_total_purchase), <span class="dv">2</span>) AS total_sales,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        ROUND(AVG(c.customer_total_purchase), <span class="dv">2</span>) AS avg_sales_customer,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>        ROUND(a.avg_order_value, <span class="dv">2</span>) AS avg_order_value</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    FROM country_customers AS c</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        country_labels AS l</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        ON l.country <span class="op">=</span> c.country</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        country_avg_order AS a</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        ON a.country_label <span class="op">=</span> l.country_label</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    GROUP BY l.country_label</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    ORDER BY</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        l.is_other ASC,</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>        total_sales DESC</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>[]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql result <span class="op">&lt;&lt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>FROM country_stats</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Returning data to local variable result</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>country_stats_df <span class="op">=</span> result.DataFrame()</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>country_stats_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">country_label</th>
<th data-quarto-table-cell-role="th">number_customers</th>
<th data-quarto-table-cell-role="th">total_sales</th>
<th data-quarto-table-cell-role="th">avg_sales_customer</th>
<th data-quarto-table-cell-role="th">avg_order_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>USA</td>
<td>13</td>
<td>1040.49</td>
<td>80.04</td>
<td>7.94</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Canada</td>
<td>8</td>
<td>535.59</td>
<td>66.95</td>
<td>7.05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Brazil</td>
<td>5</td>
<td>427.68</td>
<td>85.54</td>
<td>7.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>France</td>
<td>5</td>
<td>389.07</td>
<td>77.81</td>
<td>7.78</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Germany</td>
<td>4</td>
<td>334.62</td>
<td>83.66</td>
<td>8.16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Czech Republic</td>
<td>2</td>
<td>273.24</td>
<td>136.62</td>
<td>9.11</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>United Kingdom</td>
<td>3</td>
<td>245.52</td>
<td>81.84</td>
<td>8.77</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Portugal</td>
<td>2</td>
<td>185.13</td>
<td>92.57</td>
<td>6.38</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>India</td>
<td>2</td>
<td>183.15</td>
<td>91.58</td>
<td>8.72</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Other</td>
<td>15</td>
<td>1094.94</td>
<td>73.00</td>
<td>7.45</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can make a scatter plot with the data above in order to make results more clear.</p>
<div class="cell" data-execution_count="25">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Exclude the "Other" entry.</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>main_df <span class="op">=</span> country_stats_df.loc[country_stats_df[<span class="st">"country_label"</span>] <span class="op">!=</span> <span class="st">"Other"</span>]</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Base layer.</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> (</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    alt.Chart(main_df)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    .mark_point(size <span class="op">=</span> <span class="dv">300</span>) <span class="co"># Set default size of points to 300 pixels.</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    .encode(</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> alt.X(<span class="st">"number_customers:Q"</span>, title <span class="op">=</span> <span class="st">"Number of Customers"</span>),</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> alt.Y(<span class="st">"total_sales:Q"</span>, title <span class="op">=</span> <span class="st">"Total Sales (USD)"</span>),</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot layer.</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> base.encode(</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> alt.Color(<span class="st">"avg_sales_customer:Q"</span>, title <span class="op">=</span> <span class="st">"Average Sales per Customer (USD)"</span>),</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    tooltip <span class="op">=</span> country_stats_df.columns.tolist(),</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Text layer.</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> (</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    base</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    .mark_text( <span class="co"># Move text to the top left of each point.</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>        align <span class="op">=</span> <span class="st">"right"</span>,</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>        dy <span class="op">=</span> <span class="op">-</span><span class="dv">5</span>,</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>        dx <span class="op">=</span> <span class="op">-</span><span class="dv">20</span>,</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    .encode(</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> <span class="st">"country_label:N"</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine layers.</span></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>chart <span class="op">=</span> (</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>    (points <span class="op">+</span> text)</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>    .properties(</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Chinook Sales by Country"</span>,</span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> <span class="dv">300</span>,</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>        width <span class="op">=</span> <span class="dv">700</span>,</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>    .interactive()</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Display chart.</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>chart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="25">

<div id="altair-viz-032ae7bc766f4bc380be1def2ba86328"></div>
<script type="text/javascript">
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-032ae7bc766f4bc380be1def2ba86328") {
      outputDiv = document.getElementById("altair-viz-032ae7bc766f4bc380be1def2ba86328");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.8.1?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function loadScript(lib) {
      return new Promise(function(resolve, reject) {
        var s = document.createElement('script');
        s.src = paths[lib];
        s.async = true;
        s.onload = () => resolve(paths[lib]);
        s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
        document.getElementsByTagName("head")[0].appendChild(s);
      });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else if (typeof vegaEmbed === "function") {
      displayChart(vegaEmbed);
    } else {
      loadScript("vega")
        .then(() => loadScript("vega-lite"))
        .then(() => loadScript("vega-embed"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "layer": [{"mark": {"type": "point", "size": 300}, "encoding": {"color": {"type": "quantitative", "field": "avg_sales_customer", "title": "Average Sales per Customer (USD)"}, "tooltip": [{"type": "nominal", "field": "country_label"}, {"type": "quantitative", "field": "number_customers"}, {"type": "quantitative", "field": "total_sales"}, {"type": "quantitative", "field": "avg_sales_customer"}, {"type": "quantitative", "field": "avg_order_value"}], "x": {"type": "quantitative", "field": "number_customers", "title": "Number of Customers"}, "y": {"type": "quantitative", "field": "total_sales", "title": "Total Sales (USD)"}}, "selection": {"selector003": {"type": "interval", "bind": "scales", "encodings": ["x", "y"]}}}, {"mark": {"type": "text", "align": "right", "dx": -20, "dy": -5}, "encoding": {"text": {"type": "nominal", "field": "country_label"}, "x": {"type": "quantitative", "field": "number_customers", "title": "Number of Customers"}, "y": {"type": "quantitative", "field": "total_sales", "title": "Total Sales (USD)"}}}], "data": {"name": "data-78bcc517d9f2ead3be0976a962e20092"}, "height": 300, "title": "Chinook Sales by Country", "width": 700, "$schema": "https://vega.github.io/schema/vega-lite/v4.8.1.json", "datasets": {"data-78bcc517d9f2ead3be0976a962e20092": [{"country_label": "USA", "number_customers": 13, "total_sales": 1040.49, "avg_sales_customer": 80.04, "avg_order_value": 7.94}, {"country_label": "Canada", "number_customers": 8, "total_sales": 535.59, "avg_sales_customer": 66.95, "avg_order_value": 7.05}, {"country_label": "Brazil", "number_customers": 5, "total_sales": 427.68, "avg_sales_customer": 85.54, "avg_order_value": 7.01}, {"country_label": "France", "number_customers": 5, "total_sales": 389.07, "avg_sales_customer": 77.81, "avg_order_value": 7.78}, {"country_label": "Germany", "number_customers": 4, "total_sales": 334.62, "avg_sales_customer": 83.66, "avg_order_value": 8.16}, {"country_label": "Czech Republic", "number_customers": 2, "total_sales": 273.24, "avg_sales_customer": 136.62, "avg_order_value": 9.11}, {"country_label": "United Kingdom", "number_customers": 3, "total_sales": 245.52, "avg_sales_customer": 81.84, "avg_order_value": 8.77}, {"country_label": "Portugal", "number_customers": 2, "total_sales": 185.13, "avg_sales_customer": 92.57, "avg_order_value": 6.38}, {"country_label": "India", "number_customers": 2, "total_sales": 183.15, "avg_sales_customer": 91.58, "avg_order_value": 8.72}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<p>Looking at the top right of the chart, we can see that the USA has the highest number of Chinook customers (13), as well as the highest total sales (USD 1040.49). All of the other countries have only 2 to 8 customers.</p>
<p>On the other hand, the Czech Republic has the highest average sales per customer at USD 136.62; this is indicated by its dark color in the chart. This country also had the highest average order value at USD 9.11. This means that though the country has few customers, these people are avid buyers of music.</p>
<p>Chinook may benefit from marketing its service more aggressively in countries other than the USA where it has gained a good foothold, such as <strong>Canada, Brazil, and France</strong>. Chinook may also target the <strong>Czech Republic</strong> since the customers there seem to buy a lot of music on a per-person basis.</p>
</section>
<section id="comparing-purchase-types-full-album-vs-selected-sets" class="level2">
<h2 class="anchored" data-anchor-id="comparing-purchase-types-full-album-vs-selected-sets">Comparing Purchase Types: Full Album vs Selected Sets</h2>
<p>In our last scenario, we have been requested to compare the popularities of Chinook’s two purchase types:</p>
<ul>
<li>Full album
<ul>
<li>The customer buys a full album.</li>
<li>Albums are pre-defined in Chinook’s library. The customer may not add other tracks on top of an album.</li>
</ul></li>
<li>Selected set of tracks
<ul>
<li>The customer manually selects any number of individual tracks.</li>
</ul></li>
</ul>
<p>In both cases, each track is bought at its unit price; there are no discounts.</p>
<p>Currently, Chinook’s purchasing strategy is to <strong>buy full albums</strong> from record companies. However, Chinook doesn’t know whether full album purchases are popular among its customers. If selected sets are more popular, then Chinook may switch to a new strategy in which it will only <strong>buy the most popular individual tracks</strong> from record companies.</p>
<p>Our analysis will help Chinook make the final decision. For each purchase type, we will show the number of invoices and percentage of all invoices with that type. The type with the higher number will be the more popular one.</p>
<p>First, we create a view, <code>invoice_tracks</code>, that shows all tracks under each invoice. The album associated with each track is also shown.</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS invoice_tracks_bought<span class="op">;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW invoice_tracks_bought AS</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>        iv.invoice_id AS invoice_id,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        il.track_id AS track_id,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        t.name AS track_name,</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>        t.album_id AS album_id,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        a.title AS album_name</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    FROM invoice AS iv</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>        invoice_line AS il</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        ON il.invoice_id <span class="op">=</span> iv.invoice_id</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>        track AS t</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>        ON t.track_id <span class="op">=</span> il.track_id</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>        album AS a</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>        ON a.album_id <span class="op">=</span> t.album_id</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    ORDER BY invoice_id, track_id, album_id</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>FROM invoice_tracks_bought</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">7</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="26">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">invoice_id</th>
<th data-quarto-table-cell-role="th">track_id</th>
<th data-quarto-table-cell-role="th">track_name</th>
<th data-quarto-table-cell-role="th">album_id</th>
<th data-quarto-table-cell-role="th">album_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1158</td>
<td>Right Next Door to Hell</td>
<td>91</td>
<td>Use Your Illusion I</td>
</tr>
<tr class="even">
<td>1</td>
<td>1159</td>
<td>Dust N' Bones</td>
<td>91</td>
<td>Use Your Illusion I</td>
</tr>
<tr class="odd">
<td>1</td>
<td>1160</td>
<td>Live and Let Die</td>
<td>91</td>
<td>Use Your Illusion I</td>
</tr>
<tr class="even">
<td>1</td>
<td>1161</td>
<td>Don't Cry (Original)</td>
<td>91</td>
<td>Use Your Illusion I</td>
</tr>
<tr class="odd">
<td>1</td>
<td>1162</td>
<td>Perfect Crime</td>
<td>91</td>
<td>Use Your Illusion I</td>
</tr>
<tr class="even">
<td>1</td>
<td>1163</td>
<td>You Ain't the First</td>
<td>91</td>
<td>Use Your Illusion I</td>
</tr>
<tr class="odd">
<td>1</td>
<td>1164</td>
<td>Bad Obsession</td>
<td>91</td>
<td>Use Your Illusion I</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Then, we create a view called <code>invoice_album</code>, which shows only the album associated with the first track of each invoice. This way, there is only <strong>one row per invoice</strong>. We will also include the total purchase amount of each invoice so that we can use it later.</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS invoice_album<span class="op">;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW invoice_album AS </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>        itb.invoice_id AS invoice_id,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>        MIN(itb.album_id) AS album_id,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>        itb.album_name AS album_name,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>        iv.total AS total_purchase</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    FROM invoice_tracks_bought AS itb</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        invoice AS iv</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>        ON iv.invoice_id <span class="op">=</span> itb.invoice_id</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    GROUP BY itb.invoice_id</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    ORDER BY itb.invoice_id</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>FROM invoice_album</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">5</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="27">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">invoice_id</th>
<th data-quarto-table-cell-role="th">album_id</th>
<th data-quarto-table-cell-role="th">album_name</th>
<th data-quarto-table-cell-role="th">total_purchase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>91</td>
<td>Use Your Illusion I</td>
<td>15.84</td>
</tr>
<tr class="even">
<td>2</td>
<td>20</td>
<td>The Best Of Buddy Guy - The Millenium Collection</td>
<td>9.9</td>
</tr>
<tr class="odd">
<td>3</td>
<td>203</td>
<td>A-Sides</td>
<td>1.98</td>
</tr>
<tr class="even">
<td>4</td>
<td>58</td>
<td>Come Taste The Band</td>
<td>7.92</td>
</tr>
<tr class="odd">
<td>5</td>
<td>163</td>
<td>From The Muddy Banks Of The Wishkah [live]</td>
<td>16.83</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Then, we join <code>invoice_album</code> with the <code>track</code> table in order to <strong>list all of the tracks</strong> under the album associated with each invoice. The result will be a view called <code>invoice_full_album_tracks</code>.</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS invoice_full_album_tracks<span class="op">;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW invoice_full_album_tracks AS</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        ia.<span class="op">*</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        t.track_id AS track_id,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        t.name AS track_name</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    FROM invoice_album AS ia</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    INNER JOIN</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        track AS t</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>        ON t.album_id <span class="op">=</span> ia.album_id</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    ORDER BY invoice_id, album_id, track_id</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>FROM invoice_full_album_tracks</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">5</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="28">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">invoice_id</th>
<th data-quarto-table-cell-role="th">album_id</th>
<th data-quarto-table-cell-role="th">album_name</th>
<th data-quarto-table-cell-role="th">total_purchase</th>
<th data-quarto-table-cell-role="th">track_id</th>
<th data-quarto-table-cell-role="th">track_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>91</td>
<td>Use Your Illusion I</td>
<td>15.84</td>
<td>1158</td>
<td>Right Next Door to Hell</td>
</tr>
<tr class="even">
<td>1</td>
<td>91</td>
<td>Use Your Illusion I</td>
<td>15.84</td>
<td>1159</td>
<td>Dust N' Bones</td>
</tr>
<tr class="odd">
<td>1</td>
<td>91</td>
<td>Use Your Illusion I</td>
<td>15.84</td>
<td>1160</td>
<td>Live and Let Die</td>
</tr>
<tr class="even">
<td>1</td>
<td>91</td>
<td>Use Your Illusion I</td>
<td>15.84</td>
<td>1161</td>
<td>Don't Cry (Original)</td>
</tr>
<tr class="odd">
<td>1</td>
<td>91</td>
<td>Use Your Illusion I</td>
<td>15.84</td>
<td>1162</td>
<td>Perfect Crime</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The <code>invoice_full_album_tracks</code> view looks very similar to the <code>invoice_tracks_bought</code> view at first glance. However, there is a difference:</p>
<ul>
<li><code>invoice_tracks_bought</code>
<ul>
<li>It contains the tracks <strong>bought</strong> in each invoice.</li>
<li>Each set of tracks may or may not be a full album.</li>
</ul></li>
<li><code>invoice_full_album_tracks</code>
<ul>
<li>It contains all of the tracks under one album associated with an invoice.</li>
<li>Some of these tracks <strong>may not have been bought</strong> by the customer.</li>
</ul></li>
</ul>
<p>Next, we will create a new view called <code>invoice_purchase_type</code> which indicates whether each invoice is a “Full Album” or “Selected Set” purchase.</p>
<p>In order to determine this, we will have a <code>CASE</code> statement which can be explained as follows:</p>
<ul>
<li><code>WHEN</code> clause: If the set of tracks bought and the full album are <strong>exactly the same</strong>, mark the purchase type as “Full Album”.</li>
<li><code>ELSE</code> clause: Otherwise, mark the purchase type as “Selected Set”.</li>
</ul>
<p>Inside the <code>WHEN</code> clause, we have a rather complicated-looking set of operations. Let’s look at one part:</p>
<pre><code>(
    SELECT itb.track_id
    FROM invoice_tracks_bought AS itb
    WHERE itb.invoice_id = ia.invoice_id

    EXCEPT

    SELECT ifa.track_id
    FROM invoice_full_album_tracks AS ifa
    WHERE ifa.invoice_id = ia.invoice_id
) IS NULL</code></pre>
<p>In order to make the explanation more simple, we can call the subqueries above “set 1” and “set 2”.</p>
<pre><code>(
    {set 1}

    EXCEPT

    {set 2}
) IS NULL</code></pre>
<ul>
<li>Set 1 represents all tracks bought in one invoice.</li>
<li>Set 2 represents the full set of tracks in an album associated with the invoice.</li>
<li>Via <code>EXCEPT</code> and <code>IS NULL</code>, we check whether Set 1 is a subset of Set 2.
<ul>
<li>If it is, the result is True.</li>
<li>Otherwise, False.</li>
</ul></li>
</ul>
<p>We then repeat the same process but <em>in reverse</em>, to check if Set 2 is a subset of Set 1. We thus end up with <em>two boolean values</em>, and we use the <code>AND</code> operator on these.</p>
<pre><code>(
    {set 1}

    EXCEPT

    {set 2}
) IS NULL

AND

(
    {set 2}

    EXCEPT

    {set 1}
) IS NULL</code></pre>
<p>The purpose of <code>AND</code> is to determine the following.</p>
<ul>
<li>If both conditions are True:
<ul>
<li>The two sets of tracks match exactly.</li>
<li>The invoice is a “Full Album” purchase.</li>
</ul></li>
<li>If any condition is False:
<ul>
<li>The two sets of tracks do not match exactly.</li>
<li>The invoice is a “Selected Set” purchase.</li>
</ul></li>
</ul>
<p>The full query is shown below.</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS invoice_purchase_type<span class="op">;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW invoice_purchase_type AS</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        ia.invoice_id,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>        CASE</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>            WHEN (</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>                (</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>                    SELECT itb.track_id</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>                    FROM invoice_tracks_bought AS itb</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>                    WHERE itb.invoice_id <span class="op">=</span> ia.invoice_id</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>                    EXCEPT</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>                    SELECT ifa.track_id</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>                    FROM invoice_full_album_tracks AS ifa</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>                    WHERE ifa.invoice_id <span class="op">=</span> ia.invoice_id</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>                ) IS NULL</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>                AND</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>                (</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>                    SELECT ifa.track_id</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>                    FROM invoice_full_album_tracks AS ifa</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>                    WHERE ifa.invoice_id <span class="op">=</span> ia.invoice_id</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>                    EXCEPT</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>                    SELECT itb.track_id</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>                    FROM invoice_tracks_bought AS itb</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>                    WHERE itb.invoice_id <span class="op">=</span> ia.invoice_id</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>                ) IS NULL</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>            ) THEN <span class="st">"Full Album"</span></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>            ELSE <span class="st">"Selected Set"</span></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>            END AS purchase_type,</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>        ia.total_purchase AS total_purchase</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>    FROM invoice_album AS ia</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>FROM invoice_purchase_type</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">10</span></span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="29">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">invoice_id</th>
<th data-quarto-table-cell-role="th">purchase_type</th>
<th data-quarto-table-cell-role="th">total_purchase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Full Album</td>
<td>15.84</td>
</tr>
<tr class="even">
<td>2</td>
<td>Selected Set</td>
<td>9.9</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Selected Set</td>
<td>1.98</td>
</tr>
<tr class="even">
<td>4</td>
<td>Selected Set</td>
<td>7.92</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Full Album</td>
<td>16.83</td>
</tr>
<tr class="even">
<td>6</td>
<td>Selected Set</td>
<td>1.98</td>
</tr>
<tr class="odd">
<td>7</td>
<td>Selected Set</td>
<td>10.89</td>
</tr>
<tr class="even">
<td>8</td>
<td>Selected Set</td>
<td>9.9</td>
</tr>
<tr class="odd">
<td>9</td>
<td>Selected Set</td>
<td>8.91</td>
</tr>
<tr class="even">
<td>10</td>
<td>Selected Set</td>
<td>1.98</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>With the view above, we can finally answer the question being asked. A view called <code>purchase_type_proportion</code> will be created which shows the following information per purchase type:</p>
<ul>
<li>number of invoices</li>
<li>percentage of invoices</li>
<li>average sales per invoice</li>
<li>sales in USD</li>
<li>percentage of total sales</li>
</ul>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS purchase_type_proportion<span class="op">;</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>CREATE VIEW purchase_type_proportion AS</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>        purchase_type,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>        COUNT(purchase_type) AS type_count,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>        ROUND(</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>            CAST(COUNT(purchase_type) AS Float)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">/</span> CAST(</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>                (SELECT COUNT(purchase_type)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>                 FROM invoice_purchase_type)</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>                AS Float</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>        ) AS type_percentage,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>        ROUND(</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>            AVG(total_purchase),</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>        ) AS avg_sales_per_invoice,</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>        ROUND(</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>            SUM(total_purchase),</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>        ) AS sales_number,</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>        ROUND(</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>            SUM(total_purchase)</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">/</span> (SELECT SUM(total_purchase)</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>               FROM invoice_purchase_type)</span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>        ) AS sales_percentage</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>    FROM invoice_purchase_type</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>    GROUP BY purchase_type</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>    ORDER BY type_count DESC</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Done.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>[]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql result <span class="op">&lt;&lt;</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>FROM purchase_type_proportion</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * sqlite:///private/2021-07-31-Intermediate-SQL-Files/chinook.db
Done.
Returning data to local variable result</code></pre>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>purchase_type_df <span class="op">=</span> result.DataFrame()</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>purchase_type_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">purchase_type</th>
<th data-quarto-table-cell-role="th">type_count</th>
<th data-quarto-table-cell-role="th">type_percentage</th>
<th data-quarto-table-cell-role="th">avg_sales_per_invoice</th>
<th data-quarto-table-cell-role="th">sales_number</th>
<th data-quarto-table-cell-role="th">sales_percentage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Selected Set</td>
<td>500</td>
<td>81.43</td>
<td>6.50</td>
<td>3248.19</td>
<td>68.97</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Full Album</td>
<td>114</td>
<td>18.57</td>
<td>12.82</td>
<td>1461.24</td>
<td>31.03</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The <code>type_percentage</code> column shows that the majority (81%) of all Chinook invoices are Selected Sets. Full Album purchases only make up 19% of all invoices.</p>
<p>This is shown in the pie chart below.</p>
<div class="cell" data-execution_count="33">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> sns.color_palette(<span class="st">'pastel'</span>)[:<span class="dv">2</span>]</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>plt.pie(</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> purchase_type_df[<span class="st">"type_percentage"</span>],</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> purchase_type_df[<span class="st">"purchase_type"</span>],</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> colors,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    autopct <span class="op">=</span> <span class="st">"</span><span class="sc">%0.2f%%</span><span class="st">"</span>,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Proportion of Chinook Store Invoices by Purchase Type"</span>)</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="2021-07-31-Answering-Business-Questions-Online-Music-Store-SQL_files/figure-html/cell-34-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>However, the average sales per Full Album purchase is <em>almost twice</em> that of a Selected Set purchase. This is shown in the bar chart below.</p>
<div class="cell" data-execution_count="34">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Base layer with bar chart</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> (</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    alt.Chart(purchase_type_df)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    .mark_bar()</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    .encode(</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> alt.X(<span class="st">"purchase_type:N"</span>, title <span class="op">=</span> <span class="st">"Purchase Type"</span>),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> alt.Y(<span class="st">"avg_sales_per_invoice:Q"</span>, title <span class="op">=</span> <span class="st">"Average Sales per Invoice (USD)"</span>),</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        tooltip <span class="op">=</span> purchase_type_df.columns.tolist(),</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Text layer</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> (</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    base</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    .mark_text(</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>        align <span class="op">=</span> <span class="st">"center"</span>,</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>        dy <span class="op">=</span> <span class="dv">10</span>,</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="st">"white"</span>,</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    .encode(</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> <span class="st">"avg_sales_per_invoice:Q"</span>,</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine layers into one chart</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>chart <span class="op">=</span> (</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>    (base <span class="op">+</span> text)</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    .properties(</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Average Sales per Invoice by Purchase Type"</span>,</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> <span class="dv">300</span>,</span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>        width <span class="op">=</span> <span class="dv">200</span>,</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>    .configure_axis(labelAngle <span class="op">=</span> <span class="dv">30</span>)</span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>    .interactive()</span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Display chart.</span></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>chart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="34">

<div id="altair-viz-2207cb3871f9450c872a185b560c2f9a"></div>
<script type="text/javascript">
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-2207cb3871f9450c872a185b560c2f9a") {
      outputDiv = document.getElementById("altair-viz-2207cb3871f9450c872a185b560c2f9a");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.8.1?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function loadScript(lib) {
      return new Promise(function(resolve, reject) {
        var s = document.createElement('script');
        s.src = paths[lib];
        s.async = true;
        s.onload = () => resolve(paths[lib]);
        s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
        document.getElementsByTagName("head")[0].appendChild(s);
      });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else if (typeof vegaEmbed === "function") {
      displayChart(vegaEmbed);
    } else {
      loadScript("vega")
        .then(() => loadScript("vega-lite"))
        .then(() => loadScript("vega-embed"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}, "axis": {"labelAngle": 30}}, "layer": [{"mark": "bar", "encoding": {"tooltip": [{"type": "nominal", "field": "purchase_type"}, {"type": "quantitative", "field": "type_count"}, {"type": "quantitative", "field": "type_percentage"}, {"type": "quantitative", "field": "avg_sales_per_invoice"}, {"type": "quantitative", "field": "sales_number"}, {"type": "quantitative", "field": "sales_percentage"}], "x": {"type": "nominal", "field": "purchase_type", "title": "Purchase Type"}, "y": {"type": "quantitative", "field": "avg_sales_per_invoice", "title": "Average Sales per Invoice (USD)"}}, "selection": {"selector004": {"type": "interval", "bind": "scales", "encodings": ["x", "y"]}}}, {"mark": {"type": "text", "align": "center", "color": "white", "dy": 10}, "encoding": {"text": {"type": "quantitative", "field": "avg_sales_per_invoice"}, "tooltip": [{"type": "nominal", "field": "purchase_type"}, {"type": "quantitative", "field": "type_count"}, {"type": "quantitative", "field": "type_percentage"}, {"type": "quantitative", "field": "avg_sales_per_invoice"}, {"type": "quantitative", "field": "sales_number"}, {"type": "quantitative", "field": "sales_percentage"}], "x": {"type": "nominal", "field": "purchase_type", "title": "Purchase Type"}, "y": {"type": "quantitative", "field": "avg_sales_per_invoice", "title": "Average Sales per Invoice (USD)"}}}], "data": {"name": "data-7eadde737a2270da8aabe4fb258c8521"}, "height": 300, "title": "Average Sales per Invoice by Purchase Type", "width": 200, "$schema": "https://vega.github.io/schema/vega-lite/v4.8.1.json", "datasets": {"data-7eadde737a2270da8aabe4fb258c8521": [{"purchase_type": "Selected Set", "type_count": 500, "type_percentage": 81.43, "avg_sales_per_invoice": 6.5, "sales_number": 3248.19, "sales_percentage": 68.97}, {"purchase_type": "Full Album", "type_count": 114, "type_percentage": 18.57, "avg_sales_per_invoice": 12.82, "sales_number": 1461.24, "sales_percentage": 31.03}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<p>Full Albums cost more than Selected Sets because the former tend to have more tracks. Thus, even if Full Albums only represent 19% of all invoices, these also represent <em>31% of all dollar sales</em>. This is shown in the pie chart below.</p>
<div class="cell" data-execution_count="35">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>plt.pie(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> purchase_type_df[<span class="st">"sales_percentage"</span>],</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> purchase_type_df[<span class="st">"purchase_type"</span>],</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> colors,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    autopct <span class="op">=</span> <span class="st">"</span><span class="sc">%0.2f%%</span><span class="st">"</span>,</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Proportion of Chinook Store Sales by Purchase Type"</span>)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="2021-07-31-Answering-Business-Questions-Online-Music-Store-SQL_files/figure-html/cell-36-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Overall, though, Selected Sets still represent the majority of Chinook’s invoices (81%) and sales (69%). Therefore, we recommend that Chinook shift to a new purchasing strategy in which it <strong>only buys the most popular tracks</strong> from record companies. Chinook should not buy full albums since it is less likely for customers to purchase these.</p>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>In this project, we used intermediate SQL techniques to answer business questions for a hypothetical digital media store called Chinook. We solved a total of 4 scenarios by creating views and gradually working towards a final query. We also ended each scenario with a chart that communicates our findings more engagingly.</p>
<p>Below is a summary of all of the questions and our findings.</p>
<p><br></p>
<p><em>What are the best-selling music genres with regards to USA customers? Based on this, which new albums should be purchased for the Chinook store?</em></p>
<p>Rock is the best-selling music genre as it makes up 53% of total purchases in the USA. Rock is followed by the Alternative &amp; Punk genre and Metal genre, which each make up over 10% of purchases.</p>
<p>Among the 4 new albums which may be added to the digital store, we recommend the following 3 artists’ albums: Red Tone (Punk), Slim Jim Bites (Blues), and Meteor and the Girls (Pop).</p>
<p><br></p>
<p><em>Which of Chinook’s sales support agents has the highest total sales from their assigned customers? Can the exemplary performance of these employees be explained by any information in the database?</em></p>
<p>Sales support agent Jane Peacock has the highest total sales (37% of all sales) from her customers. She also has the highest average sales per customer (USD 82).</p>
<p>However, her statistics are only slightly higher than that of her colleagues. Therefore, we cannot conclusively say that she is the best-performing agent.</p>
<p><br></p>
<p><em>What are the statistics on the customers and sales for each country where Chinook offers its service?</em></p>
<p>The USA has the highest number of Chinook customers (13), as well as the highest total sales (USD 1040.49). All of the other countries have only 2 to 8 customers.</p>
<p>We recommend marketing Chinook more aggressively in Canada, Brazil, and France since these countries have the highest number of customers after the USA. We also recommend expanding into the Czech Republic since it has a high average value of sales per customer.</p>
<p><br></p>
<p><em>How many purchases are full albums, and how many are manually selected sets of tracks? Based on this, what strategy should Chinook adopt when buying new tracks from record companies?</em></p>
<p>Selected Sets account for 81% of all invoices and 69% of total sales. Therefore, these are more popular than Full Albums.</p>
<p>Thus, we recommend that Chinook buy only the most popular tracks from record companies. This would be more cost-effective than buying full albums.</p>
<hr>
<p>That concludes this project. Thanks for reading!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="MiguelAHG/migs-germar-data-science-blog" data-repo-id="R_kgDOJySw9w" data-category="Announcements" data-category-id="DIC_kwDOJySw984CXXr6" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" data-loading="lazy" async="">
</script>
</div> <!-- /content -->



</body></html>